<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simulasi Roket Realistis</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
  <div id="rocketHeightDisplay" style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 10px; font-family: sans-serif; border-radius: 8px;">
  Tinggi Roket: <span id="rocketHeight">0</span> m
</div>

</head>
<body>
  <audio id="explosionSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_4c1fd52933.mp3" preload="auto"></audio>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js';

// Scene & Kamera
const scene = new THREE.Scene();
scene.background = new THREE.Color('#87CEEB');

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(5, 5, 15);

// Renderer
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Cahaya
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10, 20, 10);
scene.add(light);

// Landasan
const groundGeometry = new THREE.BoxGeometry(3000, 1, 3000);
const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x888888 });
const ground = new THREE.Mesh(groundGeometry, groundMaterial);
ground.position.y = -0.5;
scene.add(ground);

// Pad Melingkar
const padGeometry = new THREE.CylinderGeometry(4, 4, 0.2, 32);
const padMaterial = new THREE.MeshStandardMaterial({ color: 0x222222 });
const pad = new THREE.Mesh(padGeometry, padMaterial);
pad.position.y = 0.0;
scene.add(pad);

// Struktur Tower Peluncur
const towerMaterial = new THREE.MeshStandardMaterial({ color: 0xaa0000 });
const tower = new THREE.Group();

for (let y = 0; y < 10; y++) {
  const frame = new THREE.BoxGeometry(0.3, 0.3, 3);
  const bar = new THREE.Mesh(frame, towerMaterial);
  bar.position.set(1.5, y + 0.15, 0);
  tower.add(bar);
}
tower.position.y = 0;
scene.add(tower);

// Roket
const rocket = new THREE.Group();
rocket.position.y = 6;

// Badan utama
const body = new THREE.Mesh(
  new THREE.CylinderGeometry(0.5, 0.5, 5, 32),
  new THREE.MeshStandardMaterial({ color: 0xffffff })
);
body.position.y = -3;
rocket.add(body);

// Hiasan strip
const band = new THREE.Mesh(
  new THREE.CylinderGeometry(0.52, 0.52, 0.3, 32),
  new THREE.MeshStandardMaterial({ color: 0x000000 })
);
band.position.y = -1;
rocket.add(band);

// Cone atas
const nose = new THREE.Mesh(
  new THREE.ConeGeometry(0.5, 1, 32),
  new THREE.MeshStandardMaterial({ color: 0xffffff })
);
nose.position.y = 0;
rocket.add(nose);

// Booster samping
for (let i = -1; i <= 1; i += 2) {
  const booster = new THREE.Mesh(
    new THREE.CylinderGeometry(0.2, 0.2, 2.5, 16),
    new THREE.MeshStandardMaterial({ color: 0xffffff })
  );
  booster.position.set(i * 0.8, -4.25, 0);
  rocket.add(booster);
}

// Api Roket
const flame = new THREE.Mesh(
  new THREE.ConeGeometry(0.3, 1.5, 16),
  new THREE.MeshStandardMaterial({ color: 0xffa500, emissive: 0xff4500 })
);
flame.rotation.x = Math.PI;
flame.position.y = -6.75;
rocket.add(flame);

scene.add(rocket);

// Kontrol
let moveLeft = false;
let moveRight = false;
let tiltAngle = 0;

document.addEventListener('keydown', (event) => {
  if (event.key === 'a' || event.key === 'ArrowLeft') moveLeft = true;
  if (event.key === 'd' || event.key === 'ArrowRight') moveRight = true;
});
document.addEventListener('keyup', (event) => {
  if (event.key === 'a' || event.key === 'ArrowLeft') moveLeft = false;
  if (event.key === 'd' || event.key === 'ArrowRight') moveRight = false;
});

// Variabel kecepatan awal (diarah sumbu lokal Y roket)
let velocity = 0.1;
const acceleration = 0.0005;

let hasExploded = false;

function createExplosionParticles(position) {
  const textureLoader = new THREE.TextureLoader();
  const fireTexture = textureLoader.load('https://threejs.org/examples/textures/sprites/explosion.png');

  for (let i = 0; i < 20; i++) {
    const material = new THREE.SpriteMaterial({ map: fireTexture, transparent: true });
    const sprite = new THREE.Sprite(material);
    sprite.position.copy(position);
    sprite.scale.set(1, 1, 1);
    scene.add(sprite);

    const velocity = new THREE.Vector3(
      (Math.random() - 0.5) * 2,
      Math.random() * 2,
      (Math.random() - 0.5) * 2
    );

    let frame = 0;
    const maxFrame = 60;
    function animateSprite() {
      if (frame++ < maxFrame) {
        sprite.position.add(velocity);
        sprite.material.opacity -= 1 / maxFrame;
        requestAnimationFrame(animateSprite);
      } else {
        scene.remove(sprite);
      }
    }
    animateSprite();
  }
}

function shakeCamera(originalPosition) {
  let shakeFrame = 0;
  function shakeStep() {
    if (shakeFrame++ < 20) {
      camera.position.x = originalPosition.x + (Math.random() - 0.5) * 0.5;
      camera.position.y = originalPosition.y + (Math.random() - 0.5) * 0.5;
      camera.position.z = originalPosition.z + (Math.random() - 0.5) * 0.5;
      requestAnimationFrame(shakeStep);
    } else {
      camera.position.copy(originalPosition);
    }
  }
  shakeStep();
}




function explodeRocket() {
  hasExploded = true;
  scene.remove(rocket);

  rocket.children.forEach((part) => {
    const partClone = part.clone();
    partClone.position.copy(part.getWorldPosition(new THREE.Vector3()));
    scene.add(partClone);

    const velocity = new THREE.Vector3(
      (Math.random() - 0.5) * 0.5,
      Math.random() * 0.7 + 0.3,
      (Math.random() - 0.5) * 0.5
    );

    let frame = 0;
    const maxFrames = 120;
    function animatePart() {
      if (frame++ < maxFrames) {
        partClone.position.add(velocity);
        velocity.y -= 0.01;
        requestAnimationFrame(animatePart);
      } else {
        scene.remove(partClone);
      }
    }
    animatePart();
    shakeCamera(camera.position.clone())
  });

  const explosion = new THREE.Mesh(
    new THREE.SphereGeometry(2, 32, 32),
    new THREE.MeshStandardMaterial({ color: 0xff4500, emissive: 0xff2200, transparent: true, opacity: 0.8 })
  );
  explosion.position.copy(rocket.position);
  scene.add(explosion);

  let explosionScale = 1;
  const explosionInterval = setInterval(() => {
    explosionScale += 0.2;
    explosion.scale.set(explosionScale, explosionScale, explosionScale);
    explosion.material.opacity -= 0.02;
    if (explosion.material.opacity <= 0) {
      clearInterval(explosionInterval);
      scene.remove(explosion);
    }
  }, 30);

  // Tambahan efek
  createExplosionParticles(rocket.position);
  document.getElementById('explosionSound').play();
  shakeCamera();
}

function animate() {
  requestAnimationFrame(animate);

  velocity += acceleration;

  // Input rotasi
  if (moveLeft) {
    tiltAngle = Math.min(tiltAngle + 0.02);
  } else if (moveRight) {
    tiltAngle = Math.max(tiltAngle - 0.02);
  }
  rocket.rotation.z = tiltAngle;

  if (!hasExploded) {
    const direction = new THREE.Vector3(0, 1, 0);
    direction.applyQuaternion(rocket.quaternion);
    rocket.position.add(direction.multiplyScalar(velocity));
  }

  // Kamera mengikuti dari belakang bawah
  if (!hasExploded) {
    const camPos = new THREE.Vector3(rocket.position.x + 5, rocket.position.y + 3, rocket.position.z + 15);
    
    // Shake hanya jika roket di bawah 40m
    if (rocket.position.y < 40 ) {
      const shakeAmount = 0.3;
      camera.position.set(
        camPos.x + (Math.random() - 0.5) * shakeAmount,
        camPos.y + (Math.random() - 0.5) * shakeAmount,
        camPos.z + (Math.random() - 0.5) * shakeAmount
      );
    } else {
      camera.position.copy(camPos);
    }

    camera.lookAt(rocket.position);
  } else {
    camera.lookAt(rocket.position);
  }

  // Background berubah
  if (rocket.position.y > 100) {
    scene.background = new THREE.Color('#000011');
  } else {
    scene.background = new THREE.Color('#87CEEB');
  }

  // Deteksi tabrakan
  const rocketTopY = rocket.position.y;
  const groundY = 0;

  if (!hasExploded && rocketTopY <= groundY) {
    explodeRocket();
    return;
  }

  document.getElementById('rocketHeight').textContent = rocket.position.y.toFixed(2);

  renderer.render(scene, camera);
}


animate();
</script>
</body>
</html>
